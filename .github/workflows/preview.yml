name: Deploy preview

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: github-pages-deploy

jobs:
  preview:
    runs-on: ubuntu-latest
    env:
      GO_VERSION: 1.25.5
      HUGO_VERSION: 0.154.4
      TZ: Europe/Amsterdam
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Go
        if: github.event.action != 'closed'
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install Hugo
        if: github.event.action != 'closed'
        run: |
          curl -sLJO "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_VERSION}_linux-amd64.tar.gz"
          mkdir -p "${HOME}/.local/hugo"
          tar -C "${HOME}/.local/hugo" -xf "hugo_${HUGO_VERSION}_linux-amd64.tar.gz"
          rm "hugo_${HUGO_VERSION}_linux-amd64.tar.gz"
          echo "${HOME}/.local/hugo" >> "${GITHUB_PATH}"

      - name: Verify installations
        if: github.event.action != 'closed'
        run: |
          echo "Go: $(go version)"
          echo "Hugo: $(hugo version)"

      - name: Determine base URL
        if: github.event.action != 'closed'
        id: gh_pages_url
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_BASE_URL="${REPO_OWNER}.github.io/${{ github.event.repository.name }}"
          echo "repo_base_url=${REPO_BASE_URL}" >> $GITHUB_OUTPUT
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "url=https://${REPO_BASE_URL}/preview/pr-${{ github.event.number }}/" >> $GITHUB_OUTPUT
          else
            echo "url=https://${REPO_BASE_URL}/preview/latest/" >> $GITHUB_OUTPUT
          fi

      - name: Build site
        if: github.event.action != 'closed'
        run: |
          chmod +x setup-dev.sh
          ./setup-dev.sh
          docker run --rm -v $(pwd)/structurizr:/usr/local/structurizr -v $(pwd)/static/diagrammen:/out structurizr/cli export --workspace workspace.dsl --format static --output /out
          hugo --minify --baseURL "${{ steps.gh_pages_url.outputs.url }}"

      - name: Override robots.txt (disallow indexing)
        if: github.event.action != 'closed'
        run: |
          echo "User-agent: *" > public/robots.txt
          echo "Disallow: /" >> public/robots.txt

      - name: Upload artifact
        if: github.event.action != 'closed'
        uses: actions/upload-artifact@v6
        with:
          name: preview-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || 'latest' }}
          path: ./public/

      - name: Deploy PR preview
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && github.actor != 'dependabot[bot]'
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: ./public/
          preview-branch: previews
          umbrella-dir: preview
          pages-base-url: ${{ steps.gh_pages_url.outputs.repo_base_url }}
          qr-code: true
          wait-for-pages-deployment: true
          action: auto

      - name: Deploy main preview
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ./public/
          branch: previews
          target-folder: preview/latest
