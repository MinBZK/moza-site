{{- $secondNav := .Params.second_nav | default "" -}}
{{- $hasSecondNav := ne $secondNav "" -}}

<header>
  <div class="banner">
    <div class="site-info">
      <p class="title">
        {{ if not .IsHome }}<a href="{{ .Site.Home.RelPermalink }}">{{ end }}{{ .Site.Title }}{{ if not .IsHome }}</a>{{ end }}
      </p>
      <p class="tagline">{{ .Site.Params.tagline }}</p>
    </div>
    <div class="site-logo">
      {{ if .IsHome }}
      <img src="{{ relURL "images/logo-rijksoverheid.svg" }}" alt="Logo Rijksoverheid" />
      {{ else }}
      <a href="{{ .Site.Home.RelPermalink }}" tabindex="-1" aria-hidden="true">
        <img src="{{ relURL "images/logo-rijksoverheid.svg" }}" alt="Logo Rijksoverheid" />
      </a>
      {{ end }}
    </div>
  </div>

  <nav id="main-nav" class="navbar" aria-label="Hoofdnavigatie">
    {{- if .IsHome -}}
    <span class="title">{{ .Site.Title }}</span>
    {{- else -}}
    <a href="{{ .Site.Home.RelPermalink }}" class="title">{{ .Site.Title }}</a>
    {{- end -}}

    <div class="menu">
      <ul>
        {{- range .Site.Menus.main -}}
          {{- $isActive := or (eq $.RelPermalink .URL) (and .URL (ne .URL "/") (hasPrefix $.RelPermalink .URL)) -}}
          <li>
            <a href="{{ .URL }}" data-text="{{ .Name }}"{{ if $isActive }} class="active" aria-current="page"{{ end }}>
              {{- .Name -}}
            </a>
          </li>
        {{- end -}}
      </ul>
    </div>

    <ul class="navbar-right">
      <li>
        <button class="search-trigger" aria-label="Zoeken" aria-haspopup="dialog">
          {{- partial "icon.html" "search" -}}
          <span class="search-trigger-text">Zoeken...</span>
          <kbd class="search-shortcut">/</kbd>
        </button>
      </li>
      <li>
        <button id="theme-toggle" class="theme-toggle" aria-label="Wissel thema">
          {{- partial "icon.html" "sun" -}}
          {{- partial "icon.html" "moon" -}}
        </button>
      </li>
    </ul>

    <button class="search-trigger mobile-search" aria-label="Zoeken" aria-haspopup="dialog">
      {{- partial "icon.html" "search" -}}
    </button>

    <button class="theme-toggle mobile-theme" aria-label="Wissel thema" onclick="document.getElementById('theme-toggle').click()">
      {{- partial "icon.html" "sun" -}}
      {{- partial "icon.html" "moon" -}}
    </button>

    <button
      class="toggle"
      aria-label="Menu openen"
      aria-expanded="false"
      aria-controls="mobile-menu"
      onclick="
        const expanded = this.getAttribute('aria-expanded') === 'false';
        this.setAttribute('aria-expanded', expanded);
        this.setAttribute('aria-label', expanded ? 'Menu sluiten' : 'Menu openen');
      "
    >
      {{- partial "icon.html" "menu" -}}
    </button>

    <div id="mobile-menu" class="mobile" role="navigation" aria-label="Mobiel menu">
      <ul>
        {{- range .Site.Menus.main -}}
        <li><a href="{{ .URL }}"{{ if or ($.IsMenuCurrent "main" .) ($.HasMenuCurrent "main" .) (eq $.RelPermalink .URL) }} class="active" aria-current="page"{{ end }}>{{ .Name }}</a></li>
        {{- end -}}
      </ul>
      {{- if $hasSecondNav -}}
      <ul class="mobile-second-nav">
        {{- range index .Site.Menus $secondNav -}}
        {{- $isExact := eq $.RelPermalink .URL -}}
        {{- $isChild := and (hasPrefix $.RelPermalink .URL) (ne $.RelPermalink .URL) -}}
        {{- $class := cond $isExact "active" (cond .Params.bold "bold" "") -}}
        <li><a href="{{ .URL }}"{{ with $class }} class="{{ . }}"{{ end }}{{ if $isExact }} aria-current="page"{{ end }}>{{ .Name }}</a></li>
        {{- end -}}
      </ul>
      {{- end -}}
      {{- if .Site.Menus.secondary -}}
      <ul>
        {{- range .Site.Menus.secondary -}}
        <li><a href="{{ .URL }}" target="_blank" rel="external noopener noreferrer">{{ .Name }}</a></li>
        {{- end -}}
      </ul>
      {{- end -}}
    </div>
  </nav>

  {{- $hasPanelOpen := false -}}
  {{- if $hasSecondNav -}}
  {{- range $index, $item := index .Site.Menus $secondNav -}}
    {{- if gt $index 0 -}}
      {{- $isActive := eq $.RelPermalink .URL -}}
      {{- $isChildActive := and (hasPrefix $.RelPermalink .URL) (ne $.RelPermalink .URL) -}}
      {{- if or $isActive $isChildActive -}}{{ $hasPanelOpen = true }}{{- end -}}
    {{- end -}}
  {{- end -}}
  <nav class="navbar navbar-sub" aria-label="Sectie navigatie">
    <ul>
      {{- range $index, $item := index .Site.Menus $secondNav -}}
        {{- $isActive := eq $.RelPermalink .URL -}}
        {{- $isChildActive := and (hasPrefix $.RelPermalink .URL) (ne $.RelPermalink .URL) -}}
        {{- $class := cond $isActive "active" (cond .Params.bold "bold" "") -}}
        {{- $page := .Page -}}
        {{- $children := $page.Sections -}}
        {{- if not $children -}}{{ $children = $page.RegularPages }}{{- end -}}
        {{- $hasChildren := gt (len $children) 0 -}}
        {{- $showExpand := and $hasChildren (gt $index 0) -}}
        {{- $showToggle := and $showExpand (not (or $isActive $isChildActive)) -}}
        {{- $inSection := and $showExpand (or $isActive $isChildActive) -}}
        {{- $liClass := cond $showToggle "has-subnav" (cond $inSection "in-section" "") -}}
        <li{{ with $liClass }} class="{{ . }}"{{ end }}>
          <a href="{{ .URL }}" data-text="{{ .Name }}"{{ with $class }} class="{{ . }}"{{ end }}{{ if $isActive }} aria-current="page"{{ end }}>{{ .Name }}</a>
          {{- if $showToggle -}}
          <button class="subnav-toggle" aria-expanded="false" aria-controls="subnav-panel-{{ $index }}" aria-label="Toon submenu voor {{ .Name }}">
            <svg class="icon-expand" width="12" height="12" viewBox="0 0 12 12" aria-hidden="true"><path d="M2 4l4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
          {{- end -}}
        </li>
      {{- end -}}
    </ul>
  </nav>
  {{- range $index, $item := index .Site.Menus $secondNav -}}
    {{- if gt $index 0 -}}
    {{- $page := .Page -}}
    {{- $children := $page.Sections -}}
    {{- if not $children -}}{{ $children = $page.RegularPages }}{{- end -}}
    {{- $isActive := eq $.RelPermalink .URL -}}
    {{- $isChildActive := and (hasPrefix $.RelPermalink .URL) (ne $.RelPermalink .URL) -}}
    {{- $showPanel := or $isActive $isChildActive -}}
    {{- if gt (len $children) 0 -}}
  <div class="subnav-panel" id="subnav-panel-{{ $index }}"{{ if not $showPanel }} hidden{{ end }}>
    <ul>
      {{- range $children.ByWeight -}}
      <li><a href="{{ .RelPermalink }}"{{ if eq $.RelPermalink .RelPermalink }} class="current"{{ end }}>{{ .Title }}</a></li>
      {{- end -}}
    </ul>
  </div>
    {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- end -}}

  {{- if not .IsHome -}}
    {{- /* Breadcrumb skipLevels: 1 (home), 2 (+ second nav), 3 (+ open panel) */ -}}
    {{- $skipLevels := cond $hasPanelOpen 3 (cond $hasSecondNav 2 1) -}}
    {{- $ancestors := .Ancestors.Reverse -}}
    {{- $hasEnoughAncestors := gt (len $ancestors) $skipLevels -}}
    {{- if $hasEnoughAncestors -}}
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <ol>
      {{- range $index, $ancestor := $ancestors -}}
      {{- if ge $index $skipLevels -}}
      <li>
        <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        <span class="separator" aria-hidden="true"></span>
      </li>
      {{- end -}}
      {{- end -}}
      <li>
        <span class="current" aria-current="page">{{ .Title }}</span>
      </li>
    </ol>
  </nav>
    {{- else -}}
  <div class="breadcrumb" aria-hidden="true"></div>
    {{- end -}}
  {{- end -}}
</header>
